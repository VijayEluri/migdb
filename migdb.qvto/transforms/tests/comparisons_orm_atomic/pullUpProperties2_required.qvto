import builder_rdb;
import queries_rdb;

modeltype RDB uses "http://www.collectionspro.eu/jam/mm/rdb";

transformation pullUpProperties2_required(out inoutModel : RDB);

main() {
	var publicSchemaName : String := getDefaultSchemaName();
	//reflection of parent class
	var targetTableName : String := "parent";
	//reflection of child class in hierarchy
	var sourceTableName : String := "child"; 
	var oldFirstCollectionTableName : String := "col_child_pulled_first_pr";
	var oldSecondCollectionTableName : String := "col_child_pulled_second_pr";
	var sourceIdColumnName : String := "id_child";
	var targetIdColumnName : String := "id_parent";
	
	var removeFkFirstColect : RDB::ops::ModelOperation := _removeConstraint(
																publicSchemaName,
																oldFirstCollectionTableName,
																"fk_col_child_pulled_first_pr");
	var removeFkSecondColect : RDB::ops::ModelOperation := _removeConstraint(
																publicSchemaName,
																oldSecondCollectionTableName,
																"fk_col_child_pulled_second_pr");
	var deleteWhereCondSecondCol : String := "id_child NOT IN (SELECT id_parent FROM public.parent)";
	var deleteDataSecondColect : RDB::ops::ModelOperation := _deleteRows(
																		publicSchemaName,
																		oldSecondCollectionTableName,
																		deleteWhereCondSecondCol);
	var addFKSecondColect : RDB::ops::ModelOperation := _addForeignKey(
																publicSchemaName,
																oldSecondCollectionTableName,
																sourceIdColumnName,
																"fk_col_parent_pulled_second_pr",
																targetTableName);															
	var renameSecondColectPr : RDB::ops::ModelOperation := _renameColumn(
																	publicSchemaName,
																	oldSecondCollectionTableName,
																	sourceIdColumnName,
																	targetIdColumnName);
	var renameSecondColectTable : RDB::ops::ModelOperation := _renameTable(
																	publicSchemaName,
																	oldSecondCollectionTableName,
																	"col_parent_pulled_second_pr");
	var deleteWhereCondFirstCol : String := deleteWhereCondSecondCol;
	var deleteDataFirstCol : RDB::ops::ModelOperation := _deleteRows(
																	publicSchemaName,
																	oldFirstCollectionTableName,
																	deleteWhereCondFirstCol);
	var addFKFirstColect : RDB::ops::ModelOperation := _addForeignKey(
																publicSchemaName,
																oldFirstCollectionTableName,
																sourceIdColumnName,
																"fk_col_parent_pulled_first_pr",
																targetTableName);															
	var renameFirstColectPr : RDB::ops::ModelOperation := _renameColumn(
																	publicSchemaName,
																	oldFirstCollectionTableName,
																	sourceIdColumnName,
																	targetIdColumnName);
	var renameFirstColectTable : RDB::ops::ModelOperation := _renameTable(
																	publicSchemaName,
																	oldFirstCollectionTableName,
																	"col_parent_pulled_first_pr");
	
																																		
	var ops : OrderedSet(RDB::ops::ModelOperation):= OrderedSet{
															//change first collection
															removeFkFirstColect,
															//change second collection
															removeFkSecondColect,
															//mirrored  ops first collection
															deleteDataSecondColect,
															addFKSecondColect,
															renameSecondColectPr,
															renameSecondColectTable,
															//mirrored ops second collection
															deleteDataFirstCol,
															addFKFirstColect,
															renameFirstColectPr,
															renameFirstColectTable
															};
	var model : RDB::ModelRoot := _rdbOperations(ops);	 
}
